<!DOCTYPE html>
<html lang="en">

<head>
        <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EZW73PXVHK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-EZW73PXVHK');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Block Store - Telegram Bot Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .card-hover:hover {
            transform: translateY(-4px);
        }
    </style>
</head>

<body class="bg-gray-900 text-white min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700 h-16 flex items-center justify-between px-8 sticky top-0 z-50">
        <div class="flex items-center gap-4">
            <h1 class="font-bold text-xl tracking-wide flex items-center gap-2">
                <span class="text-2xl">üõçÔ∏è</span> Block Store
            </h1>
        </div>
        <div>
            <span class="text-xs text-gray-500 uppercase font-bold tracking-wider">Premium Extensions</span>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 container mx-auto px-8 py-12">

        <div class="mb-10 text-center">
            <h2
                class="text-3xl font-bold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">
                Supercharge your Bots</h2>
            <p class="text-gray-400 max-w-2xl mx-auto">Browse and install community-created block packages. Add powerful
                capabilities like AI, Database connectivity, and more with a single click.</p>
        </div>

        <div id="store-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Loading State -->
            <div class="col-span-full text-center py-20 text-gray-500">
                <svg class="animate-spin h-10 w-10 text-blue-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg"
                    fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                <p>Loading Store...</p>
            </div>
        </div>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', loadStore);

        async function loadStore() {
            try {
                const res = await fetch('/store/packages');
                const data = await res.json();
                const grid = document.getElementById('store-grid');
                grid.innerHTML = '';

                if (data.packages.length === 0) {
                    grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-10">No packages found in the store.</div>';
                    return;
                }

                data.packages.forEach(pkg => {
                    const card = document.createElement('div');
                    card.className = "bg-gray-800 rounded-xl border border-gray-700 p-6 shadow-xl card-hover transition-all duration-300 relative overflow-hidden group";

                    // Color accent
                    const colorClass = pkg.color === 'emerald' ? 'bg-emerald-500' :
                        (pkg.color === 'amber' ? 'bg-amber-500' : 'bg-blue-500');

                    let iconHtml = pkg.icon || 'üì¶';
                    // Check if icon is URL (starts with http or contains /)
                    if (pkg.icon && (pkg.icon.startsWith('http') || pkg.icon.startsWith('/'))) {
                        iconHtml = `<img src="${pkg.icon}" class="w-8 h-8 object-contain" alt="${pkg.name}">`;
                    }

                    card.innerHTML = `
                        <div class="absolute top-0 left-0 w-full h-1 ${colorClass}"></div>
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-12 h-12 rounded-lg bg-gray-700 flex items-center justify-center text-3xl shadow-inner border border-gray-600 overflow-hidden">
                                ${iconHtml}
                            </div>
                            <span class="text-xs font-mono bg-gray-900 text-gray-400 px-2 py-1 rounded border border-gray-700">v1.0.0</span>
                        </div>
                        
                        <h3 class="text-xl font-bold text-white mb-2 group-hover:text-blue-400 transition-colors">${pkg.name}</h3>
                        <p class="text-gray-400 text-sm mb-6 h-12 overflow-hidden">${pkg.description}</p>
                        
                        <div class="space-y-3">
                            <div class="text-xs text-gray-500 uppercase font-bold">Includes Blocks:</div>
                            <div class="flex flex-wrap gap-2">
                                ${pkg.blocks.map(b => `<span class="bg-gray-700 text-gray-300 px-2 py-0.5 rounded text-[10px] border border-gray-600">${truncate(b, 20)}</span>`).join('')}
                            </div>
                        </div>

                        <div class="mt-6 pt-4 border-t border-gray-700 flex justify-between items-center">
                            <div class="flex gap-2 text-xs text-gray-500">
                                ${pkg.dependencies.map(d => `<span>Pip: ${d}</span>`).join('')}
                            </div>
                            <button onclick="installPackage('${pkg.id}', '${pkg.dependencies.join(',')}')" 
                                class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-lg shadow-blue-900/20 transition-all active:scale-95 flex items-center gap-2">
                                <span>Get</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            </button>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            } catch (e) {
                console.error(e);
                document.getElementById('store-grid').innerHTML = '<div class="col-span-full text-red-400 text-center">Failed to load store.</div>';
            }
        }

        async function installPackage(id, depsString) {
            const btn = event.currentTarget;
            const originalText = btn.innerHTML;
            btn.innerHTML = `<svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Installing...`;
            btn.disabled = true;

            try {
                // 1. Install Blocks
                const res1 = await fetch('/store/install', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id })
                });
                const data1 = await res1.json();
                if (data1.status !== 'success') throw new Error(data1.message);

                // 2. Install Dependencies (Pip)
                const deps = depsString ? depsString.split(',') : [];
                for (let dep of deps) {
                    if (!dep) continue;
                    btn.innerHTML = `<svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Pip: ${dep}...`;

                    const res2 = await fetch('/install-library', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: dep })
                    });
                    const data2 = await res2.json();
                    if (data2.status !== 'success') console.warn(`Failed to install ${dep}: ${data2.message}`);
                }

                alert(`Successfully installed package! The blocks are now available in your Toolbox.`);
                btn.innerHTML = "Installed ‚úÖ";
                btn.classList.replace('bg-blue-600', 'bg-green-600');
                btn.classList.replace('hover:bg-blue-500', 'hover:bg-green-500');

            } catch (e) {
                alert("Error: " + e.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function truncate(str, n) {
            return (str.length > n) ? str.substr(0, n - 1) + '...' : str;
        }
    </script>
</body>

</html>